# å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»å¿«é€Ÿå‚è€ƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### ä¸‰å±‚éš”ç¦»æ¶æ„
```
ç³»ç»Ÿå±‚ (System) â†’ ç§Ÿæˆ·å±‚ (Tenant) â†’ å®¢æˆ·å±‚ (Customer)
```

### éš”ç¦»å­—æ®µå†³ç­–è¡¨

| é—®é¢˜ | tenant_id | customer_id |
|------|-----------|-------------|
| æ˜¯ç§Ÿæˆ·è¡¨æœ¬èº«? | âŒ | âŒ |
| æ˜¯å®¢æˆ·è¡¨? | âœ… å¿…å¡« | âŒ |
| æ˜¯ç»„ç»‡æ¶æ„(éƒ¨é—¨/è§’è‰²/å²—ä½)? | âœ… å¿…å¡« | âŒ |
| æ˜¯ç”¨æˆ·è¡¨? | âœ… å¿…å¡« | âœ… å¯é€‰ |
| æ˜¯é…ç½®ç±»(èœå•/å­—å…¸/å‚æ•°)? | âœ… å¯é€‰ | âŒ |
| æ˜¯ä¸šåŠ¡æ•°æ®? | âœ… å¿…å¡« | âœ… æ ¹æ®ä¸šåŠ¡ |
| æ˜¯æ—¥å¿—/é€šçŸ¥? | âœ… å¿…å¡« | âœ… æ ¹æ®æ“ä½œäºº |

## ğŸ“Š æ•°æ®æƒé™ (data_scope)

| å€¼ | åç§° | SQL WHERE æ¡ä»¶ |
|----|------|----------------|
| 1 | ä»…æœ¬äºº | `created_id = current_user.id` |
| 2 | æœ¬éƒ¨é—¨ | `user.dept_id = current_user.dept_id` |
| 3 | æœ¬éƒ¨é—¨åŠä»¥ä¸‹ | `dept.tree_path LIKE 'current%'` |
| 4 | å…¨éƒ¨æ•°æ® | `tenant_id = current_user.tenant_id` |
| 5 | è‡ªå®šä¹‰ | `dept_id IN (role_depts)` |

**å®¢æˆ·ç”¨æˆ·ç‰¹æ®Šè§„åˆ™**: æ— è®ºä»€ä¹ˆæƒé™,éƒ½é¢å¤–åŠ  `customer_id = current_user.customer_id`

## ğŸ”§ ä»£ç æ¨¡æ¿

### 1. ç§Ÿæˆ·çº§ä¸šåŠ¡è¡¨

```python
class ProductModel(ModelMixin):
    """äº§å“è¡¨ - ç§Ÿæˆ·çº§"""
    __tablename__ = "business_product"
    
    name: Mapped[str] = mapped_column(String(100), comment="äº§å“åç§°")
    
    # æ•°æ®éš”ç¦»
    tenant_id: Mapped[int] = mapped_column(
        Integer, 
        ForeignKey("system_tenant.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True
    )
    created_id: Mapped[int | None] = mapped_column(
        Integer, 
        ForeignKey("system_user.id", ondelete="SET NULL"), 
        nullable=True
    )
```

### 2. å®¢æˆ·çº§ä¸šåŠ¡è¡¨

```python
class OrderModel(ModelMixin):
    """è®¢å•è¡¨ - å®¢æˆ·çº§"""
    __tablename__ = "business_order"
    
    order_no: Mapped[str] = mapped_column(String(50), comment="è®¢å•å·")
    
    # æ•°æ®éš”ç¦»
    tenant_id: Mapped[int] = mapped_column(
        Integer, 
        ForeignKey("system_tenant.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True
    )
    customer_id: Mapped[int | None] = mapped_column(
        Integer, 
        ForeignKey("system_customer.id", ondelete="CASCADE"), 
        nullable=True,  # å¯é€‰,å®¢æˆ·è®¢å•æ—¶å¿…å¡«
        index=True
    )
    created_id: Mapped[int | None] = mapped_column(
        Integer, 
        ForeignKey("system_user.id", ondelete="SET NULL"), 
        nullable=True
    )
```

### 3. æŸ¥è¯¢è¿‡æ»¤å™¨

```python
class DataPermissionFilter:
    """é€šç”¨æ•°æ®æƒé™è¿‡æ»¤å™¨"""
    
    @staticmethod
    def apply(query: Select, model, user: UserModel) -> Select:
        # 1. ç§Ÿæˆ·éš”ç¦» (å¿…é¡»)
        query = query.where(model.tenant_id == user.tenant_id)
        
        # 2. å®¢æˆ·éš”ç¦» (å¦‚æœæ˜¯å®¢æˆ·ç”¨æˆ·)
        if user.customer_id:
            query = query.where(model.customer_id == user.customer_id)
        
        # 3. æ•°æ®æƒé™
        max_scope = max(int(r.data_scope) for r in user.roles)
        
        if max_scope == 1:  # ä»…æœ¬äºº
            query = query.where(model.created_id == user.id)
        
        elif max_scope == 2:  # æœ¬éƒ¨é—¨
            query = query.where(
                model.created_id.in_(
                    select(UserModel.id)
                    .where(UserModel.dept_id == user.dept_id)
                )
            )
        
        elif max_scope == 3:  # æœ¬éƒ¨é—¨åŠä»¥ä¸‹
            query = query.where(
                model.created_id.in_(
                    select(UserModel.id)
                    .join(DeptModel)
                    .where(DeptModel.tree_path.like(f'{user.dept.tree_path}%'))
                )
            )
        
        # 4 å’Œ 5 çœç•¥...
        
        return query
```

### 4. åˆ›å»ºè®°å½•

```python
async def create_order(data: dict, current_user: UserModel):
    new_order = OrderModel(
        **data,
        tenant_id=current_user.tenant_id,  # å¿…é¡»
        customer_id=current_user.customer_id,  # å¦‚æœæ˜¯å®¢æˆ·ç”¨æˆ·
        created_id=current_user.id,
        updated_id=current_user.id
    )
    session.add(new_order)
    await session.commit()
```

## âš ï¸ å¸¸è§é”™è¯¯

### âŒ é”™è¯¯1: ç¼ºå°‘ç§Ÿæˆ·è¿‡æ»¤

```python
# å±é™©! å¯èƒ½æŸ¥åˆ°å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®
query = select(Model).where(Model.name == 'xxx')
```

**âœ… æ­£ç¡®**:
```python
query = (
    select(Model)
    .where(Model.tenant_id == current_user.tenant_id)
    .where(Model.name == 'xxx')
)
```

### âŒ é”™è¯¯2: å®¢æˆ·ç”¨æˆ·ç¼ºå°‘customer_idè¿‡æ»¤

```python
# å®¢æˆ·ç”¨æˆ·å¯èƒ½çœ‹åˆ°å…¶ä»–å®¢æˆ·çš„æ•°æ®
query = select(Model).where(Model.tenant_id == current_user.tenant_id)
```

**âœ… æ­£ç¡®**:
```python
query = select(Model).where(Model.tenant_id == current_user.tenant_id)
if current_user.customer_id:
    query = query.where(Model.customer_id == current_user.customer_id)
```

### âŒ é”™è¯¯3: ç»™ä¸è¯¥æœ‰çš„è¡¨åŠ customer_id

```python
# é”™è¯¯: éƒ¨é—¨ä¸å±äºå®¢æˆ·
class DeptModel(ModelMixin):
    customer_id: Mapped[int]  # âŒ
```

**âœ… æ­£ç¡®**:
```python
class DeptModel(ModelMixin):
    tenant_id: Mapped[int]  # âœ… åªéœ€è¦tenant_id
```

### âŒ é”™è¯¯4: ç§Ÿæˆ·è¡¨åŠ tenant_id

```python
# é”™è¯¯: ç§Ÿæˆ·ä¸å±äºç§Ÿæˆ·
class TenantModel(ModelMixin):
    tenant_id: Mapped[int]  # âŒ å¾ªç¯å¼•ç”¨
```

**âœ… æ­£ç¡®**:
```python
class TenantModel(ModelMixin):
    # ä¸éœ€è¦tenant_id âœ…
    created_id: Mapped[int | None]  # åªéœ€è¦å®¡è®¡å­—æ®µ
```

## ğŸ“ æ£€æŸ¥æ¸…å•

åˆ›å»ºæ–°è¡¨æ—¶,è¯·æ£€æŸ¥:

- [ ] æ˜¯å¦éœ€è¦ `tenant_id`? (å‡ ä¹æ‰€æœ‰ä¸šåŠ¡è¡¨éƒ½éœ€è¦)
- [ ] æ˜¯å¦éœ€è¦ `customer_id`? (åªæœ‰éƒ¨åˆ†è¡¨éœ€è¦)
- [ ] æ˜¯å¦éœ€è¦ `created_id/updated_id`? (æ¨èåŠ ä¸Š,ç”¨äºå®¡è®¡)
- [ ] æ˜¯å¦åˆ›å»ºäº†å¿…è¦çš„ç´¢å¼•?
  - [ ] `idx_tenant_id`
  - [ ] `idx_customer_id` (å¦‚æœæœ‰)
  - [ ] `idx_created_id` (å¦‚æœæœ‰)
- [ ] å…³è”å…³ç³»æ˜¯å¦æ­£ç¡®è®¾ç½®äº† `foreign_keys`?
- [ ] æ˜¯å¦åœ¨ `TYPE_CHECKING` ä¸‹å¯¼å…¥ç›¸å…³æ¨¡å‹?

æŸ¥è¯¢æ—¶,è¯·æ£€æŸ¥:

- [ ] æ˜¯å¦æ·»åŠ äº† `tenant_id` è¿‡æ»¤?
- [ ] å¦‚æœå½“å‰ç”¨æˆ·æ˜¯å®¢æˆ·ç”¨æˆ·,æ˜¯å¦æ·»åŠ äº† `customer_id` è¿‡æ»¤?
- [ ] æ˜¯å¦æ ¹æ®è§’è‰²çš„ `data_scope` æ·»åŠ äº†æ•°æ®æƒé™è¿‡æ»¤?
- [ ] æ˜¯å¦ä½¿ç”¨äº†æ•°æ®æƒé™è¿‡æ»¤å™¨ä¸­é—´ä»¶?

åˆ›å»º/æ›´æ–°è®°å½•æ—¶,è¯·æ£€æŸ¥:

- [ ] æ˜¯å¦è®¾ç½®äº† `tenant_id`?
- [ ] æ˜¯å¦æ ¹æ®å½“å‰ç”¨æˆ·è®¾ç½®äº† `customer_id`?
- [ ] æ˜¯å¦è®¾ç½®äº† `created_id/updated_id`?

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å¿…é¡»åˆ›å»ºçš„ç´¢å¼•

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_tenant_id ON table_name(tenant_id);
CREATE INDEX idx_customer_id ON table_name(customer_id);
CREATE INDEX idx_created_id ON table_name(created_id);

-- è”åˆç´¢å¼• (æå‡æŸ¥è¯¢æ€§èƒ½)
CREATE INDEX idx_tenant_customer ON table_name(tenant_id, customer_id);
CREATE INDEX idx_tenant_status ON table_name(tenant_id, status);

-- æ ‘å½¢è·¯å¾„ç´¢å¼• (æœ¬éƒ¨é—¨åŠä»¥ä¸‹æŸ¥è¯¢)
CREATE INDEX idx_tree_path ON system_dept(tree_path);
```

### åˆ†åŒºè¡¨ (å¤§æ•°æ®é‡åœºæ™¯)

```sql
-- æŒ‰ç§Ÿæˆ·åˆ†åŒº
CREATE TABLE orders (
    id BIGINT,
    tenant_id INT,
    ...
) PARTITION BY HASH(tenant_id) PARTITIONS 10;
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

è¯¦ç»†è®¾è®¡è¯·å‚è€ƒ: [å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»è®¾è®¡æ–¹æ¡ˆ.md](./å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»è®¾è®¡æ–¹æ¡ˆ.md)
