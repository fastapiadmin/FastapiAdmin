# å¤šç§Ÿæˆ·ç³»ç»Ÿä¼˜åŒ–è®°å½•

## ä¼˜åŒ–æ—¥æœŸ
2025-11-22

## ä¼˜åŒ–å†…å®¹

### 1. ä¸ºTenantModelè¡¥å……åå‘å…³è” âœ…

**ä¼˜åŒ–å‰:**
- TenantModelåªæœ‰ `users`, `depts`, `customers` ä¸‰ä¸ªåå‘å…³è”

**ä¼˜åŒ–å:**
- æ–°å¢ `roles`, `positions`, `menus` åå‘å…³è”
- ç°åœ¨å¯ä»¥é€šè¿‡ `tenant.roles`, `tenant.positions`, `tenant.menus` è®¿é—®ç§Ÿæˆ·çš„æ‰€æœ‰è§’è‰²ã€å²—ä½ã€èœå•

**å½±å“æ–‡ä»¶:**
- `app/api/v1/module_system/tenant/model.py`

**å¥½å¤„:**
- å®Œå–„ORMå…³è”å…³ç³»
- æå‡æŸ¥è¯¢ä¾¿åˆ©æ€§
- æ”¯æŒ `tenant.roles` ç­‰ç›´æ¥è®¿é—®

---

### 2. æ·»åŠ è”åˆå”¯ä¸€ç´¢å¼•(tenant_id + code) âœ…

**ä¼˜åŒ–åŸå› :**
- åŸè®¾è®¡ `code` å­—æ®µä¸ºå…¨å±€å”¯ä¸€,ä¸ç¬¦åˆå¤šç§Ÿæˆ·éš”ç¦»åŸåˆ™
- ä¸åŒç§Ÿæˆ·åº”è¯¥å…è®¸ä½¿ç”¨ç›¸åŒçš„ç¼–ç 

**ä¼˜åŒ–æ–¹æ¡ˆ:**
- ç§»é™¤ `code` å­—æ®µçš„å…¨å±€å”¯ä¸€çº¦æŸ(`unique=True`)
- æ·»åŠ  `UniqueConstraint('tenant_id', 'code')` è”åˆå”¯ä¸€ç´¢å¼•
- æ·»åŠ  `index=True` åˆ° `code` å­—æ®µæå‡æŸ¥è¯¢æ€§èƒ½

**å½±å“çš„è¡¨:**

| è¡¨å | ç´¢å¼•åç§° | ç´¢å¼•å­—æ®µ |
|------|---------|---------|
| `system_customer` | `uq_customer_tenant_code` | `(tenant_id, code)` |
| `system_dept` | `uq_dept_tenant_code` | `(tenant_id, code)` |
| `system_role` | `uq_role_tenant_code` | `(tenant_id, code)` |

**æ³¨æ„:**
- `system_tenant` è¡¨ä¸éœ€è¦æ­¤ç´¢å¼•(ç§Ÿæˆ·è¡¨æœ¬èº«æ²¡æœ‰tenant_idå­—æ®µ)
- ç§Ÿæˆ·çš„ `code` ä¿æŒå…¨å±€å”¯ä¸€(`unique=True`)

**å½±å“æ–‡ä»¶:**
- `app/api/v1/module_system/customer/model.py`
- `app/api/v1/module_system/dept/model.py`
- `app/api/v1/module_system/role/model.py`

**å¥½å¤„:**
- âœ… ç¬¦åˆå¤šç§Ÿæˆ·éš”ç¦»åŸåˆ™
- âœ… ä¸åŒç§Ÿæˆ·å¯ä»¥ä½¿ç”¨ç›¸åŒç¼–ç 
- âœ… ä¿è¯åŒä¸€ç§Ÿæˆ·å†…ç¼–ç å”¯ä¸€
- âœ… æå‡æŸ¥è¯¢æ€§èƒ½

**ç¤ºä¾‹:**
```python
# ä¼˜åŒ–å‰: å…¨å±€å”¯ä¸€,ç§Ÿæˆ·Aå’Œç§Ÿæˆ·Bä¸èƒ½éƒ½ä½¿ç”¨"ADMIN"ç¼–ç 
# ç§Ÿæˆ·Açš„è§’è‰²: code="ADMIN"  âœ…
# ç§Ÿæˆ·Bçš„è§’è‰²: code="ADMIN"  âŒ å”¯ä¸€çº¦æŸå†²çª

# ä¼˜åŒ–å: ç§Ÿæˆ·å†…å”¯ä¸€,ä¸åŒç§Ÿæˆ·å¯ä»¥ä½¿ç”¨ç›¸åŒç¼–ç 
# ç§Ÿæˆ·Açš„è§’è‰²: (tenant_id=1, code="ADMIN")  âœ…
# ç§Ÿæˆ·Bçš„è§’è‰²: (tenant_id=2, code="ADMIN")  âœ…
# ç§Ÿæˆ·Açš„è§’è‰²: (tenant_id=1, code="ADMIN")  âŒ è”åˆå”¯ä¸€çº¦æŸå†²çª
```

---

### 3. æ·»åŠ è½¯åˆ é™¤æ”¯æŒ(deleted_atå­—æ®µ) âœ…

**ä¼˜åŒ–æ–¹æ¡ˆ:**
- åœ¨ `ModelMixin` åŸºç±»ä¸­æ·»åŠ  `deleted_at` å­—æ®µ
- æ‰€æœ‰ç»§æ‰¿ `ModelMixin` çš„æ¨¡å‹è‡ªåŠ¨æ”¯æŒè½¯åˆ é™¤

**å­—æ®µå®šä¹‰:**
```python
deleted_at: Mapped[datetime | None] = mapped_column(
    DateTime, 
    default=None, 
    nullable=True, 
    index=True, 
    comment='è½¯åˆ é™¤æ—¶é—´(NULL:æœªåˆ é™¤, æ—¶é—´æˆ³:å·²åˆ é™¤)'
)
```

**è½¯åˆ é™¤æœºåˆ¶:**
- `deleted_at = NULL`: æ­£å¸¸æ•°æ®(æœªåˆ é™¤)
- `deleted_at = æ—¶é—´æˆ³`: å·²åˆ é™¤æ•°æ®
- æŸ¥è¯¢æ—¶é»˜è®¤è¿‡æ»¤: `WHERE deleted_at IS NULL`
- åˆ é™¤æ—¶è®¾ç½®: `UPDATE ... SET deleted_at = NOW() WHERE id = ?`

**å½±å“æ–‡ä»¶:**
- `app/core/base_model.py`

**å¥½å¤„:**
- âœ… æ•°æ®å¯æ¢å¤(è¯¯åˆ é™¤ä¿æŠ¤)
- âœ… ä¿ç•™å®Œæ•´å®¡è®¡è¿½è¸ª
- âœ… ç¬¦åˆä¼ä¸šçº§æ•°æ®ç®¡ç†è§„èŒƒ
- âœ… æ”¯æŒæ•°æ®å½’æ¡£å’Œå›æ”¶ç«™åŠŸèƒ½

**æ³¨æ„äº‹é¡¹:**

âš ï¸ **å”¯ä¸€ç´¢å¼•éœ€è¦åŒ…å«deleted_atå­—æ®µ**
```python
# é”™è¯¯ç¤ºä¾‹(å¯èƒ½å¯¼è‡´å·²åˆ é™¤æ•°æ®ä¸æ­£å¸¸æ•°æ®å†²çª)
UniqueConstraint('tenant_id', 'code')

# æ­£ç¡®ç¤ºä¾‹(å…è®¸åˆ é™¤åé‡æ–°åˆ›å»ºç›¸åŒcode)
UniqueConstraint('tenant_id', 'code', 'deleted_at')
# æˆ–è€…ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•(ä»…ç´¢å¼•æœªåˆ é™¤æ•°æ®)
Index('uq_tenant_code', 'tenant_id', 'code', 
      postgresql_where=(deleted_at.is_(None)))
```

âš ï¸ **æŸ¥è¯¢éœ€è¦é»˜è®¤è¿‡æ»¤deleted_at**
```python
# æ¨èåœ¨RepositoryåŸºç±»æˆ–CRUDåŸºç±»ä¸­æ·»åŠ é»˜è®¤è¿‡æ»¤
class BaseRepository:
    def get_query(self, include_deleted=False):
        query = select(self.model)
        if not include_deleted:
            query = query.where(self.model.deleted_at.is_(None))
        return query

# æŸ¥è¯¢æ­£å¸¸æ•°æ®
users = session.execute(select(UserModel).where(UserModel.deleted_at.is_(None)))

# æŸ¥è¯¢å·²åˆ é™¤æ•°æ®(å›æ”¶ç«™åŠŸèƒ½)
deleted_users = session.execute(select(UserModel).where(UserModel.deleted_at.is_not(None)))

# æ¢å¤æ•°æ®
user.deleted_at = None
```

âš ï¸ **åˆ é™¤æ“ä½œæ”¹ä¸ºæ›´æ–°**
```python
# è½¯åˆ é™¤
user.deleted_at = datetime.now()
session.commit()

# æ°¸ä¹…åˆ é™¤(æ…ç”¨)
session.delete(user)
session.commit()
```

---

## æ•°æ®åº“è¿ç§»å»ºè®®

### æ–¹æ¡ˆ1: ä½¿ç”¨Alembicè¿ç§»(æ¨è)

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "ä¼˜åŒ–å¤šç§Ÿæˆ·ç³»ç»Ÿ: æ·»åŠ è”åˆå”¯ä¸€ç´¢å¼•å’Œè½¯åˆ é™¤"

# 2. æ£€æŸ¥ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
# ç¡®è®¤ä»¥ä¸‹å†…å®¹:
# - åˆ é™¤æ—§çš„uniqueçº¦æŸ
# - æ·»åŠ æ–°çš„è”åˆå”¯ä¸€çº¦æŸ
# - æ·»åŠ deleted_atå­—æ®µ

# 3. æ‰§è¡Œè¿ç§»
alembic upgrade head
```

### æ–¹æ¡ˆ2: æ‰‹åŠ¨SQL(ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨)

```sql
-- 1. æ·»åŠ deleted_atå­—æ®µ
ALTER TABLE system_tenant ADD COLUMN deleted_at TIMESTAMP NULL;
ALTER TABLE system_customer ADD COLUMN deleted_at TIMESTAMP NULL;
ALTER TABLE system_dept ADD COLUMN deleted_at TIMESTAMP NULL;
ALTER TABLE system_role ADD COLUMN deleted_at TIMESTAMP NULL;
-- ... å…¶ä»–è¡¨

-- 2. æ·»åŠ ç´¢å¼•
CREATE INDEX idx_tenant_deleted_at ON system_tenant(deleted_at);
CREATE INDEX idx_customer_deleted_at ON system_customer(deleted_at);
-- ... å…¶ä»–è¡¨

-- 3. åˆ é™¤æ—§çš„å”¯ä¸€çº¦æŸ
ALTER TABLE system_customer DROP CONSTRAINT IF EXISTS system_customer_code_key;
ALTER TABLE system_dept DROP CONSTRAINT IF EXISTS system_dept_code_key;
ALTER TABLE system_role DROP CONSTRAINT IF EXISTS system_role_code_key;

-- 4. æ·»åŠ è”åˆå”¯ä¸€çº¦æŸ
ALTER TABLE system_customer ADD CONSTRAINT uq_customer_tenant_code UNIQUE (tenant_id, code);
ALTER TABLE system_dept ADD CONSTRAINT uq_dept_tenant_code UNIQUE (tenant_id, code);
ALTER TABLE system_role ADD CONSTRAINT uq_role_tenant_code UNIQUE (tenant_id, code);
```

---

## æµ‹è¯•å»ºè®®

### 1. è”åˆå”¯ä¸€ç´¢å¼•æµ‹è¯•
```python
# æµ‹è¯•ä¸åŒç§Ÿæˆ·å¯ä»¥ä½¿ç”¨ç›¸åŒç¼–ç 
tenant1_role = RoleModel(tenant_id=1, code="ADMIN", name="ç®¡ç†å‘˜")
tenant2_role = RoleModel(tenant_id=2, code="ADMIN", name="ç®¡ç†å‘˜")
session.add_all([tenant1_role, tenant2_role])
session.commit()  # åº”è¯¥æˆåŠŸ

# æµ‹è¯•åŒä¸€ç§Ÿæˆ·ä¸èƒ½ä½¿ç”¨é‡å¤ç¼–ç 
duplicate_role = RoleModel(tenant_id=1, code="ADMIN", name="é‡å¤")
session.add(duplicate_role)
session.commit()  # åº”è¯¥æŠ›å‡ºIntegrityError
```

### 2. è½¯åˆ é™¤æµ‹è¯•
```python
# è½¯åˆ é™¤
user.deleted_at = datetime.now()
session.commit()

# æŸ¥è¯¢æ—¶åº”è¯¥è¿‡æ»¤æ‰å·²åˆ é™¤æ•°æ®
active_users = session.execute(
    select(UserModel).where(UserModel.deleted_at.is_(None))
).scalars().all()
assert user not in active_users

# æ¢å¤æ•°æ®
user.deleted_at = None
session.commit()
assert user in active_users
```

### 3. åå‘å…³è”æµ‹è¯•
```python
# æµ‹è¯•ç§Ÿæˆ·çš„åå‘å…³è”
tenant = session.get(TenantModel, 1)
assert hasattr(tenant, 'roles')
assert hasattr(tenant, 'positions')
assert hasattr(tenant, 'menus')

roles = tenant.roles
positions = tenant.positions
menus = tenant.menus
```

---

## å‡çº§å½±å“è¯„ä¼°

### å…¼å®¹æ€§å½±å“
- âœ… **å‘åå…¼å®¹**: æ–°å¢å­—æ®µå’Œç´¢å¼•ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âš ï¸ **éœ€è¦æ³¨æ„**: å¦‚æœä»£ç ä¸­ç¡¬ç¼–ç äº† `code` å…¨å±€å”¯ä¸€çš„é€»è¾‘,éœ€è¦ä¿®æ”¹

### æ€§èƒ½å½±å“
- âœ… **æ­£é¢å½±å“**: æ·»åŠ ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
- âœ… **è´Ÿé¢å½±å“**: å¯å¿½ç•¥(ç´¢å¼•ç»´æŠ¤å¼€é”€å¾ˆå°)

### æ•°æ®å½±å“
- âœ… **æ— æ•°æ®ä¸¢å¤±é£é™©**
- âš ï¸ **éœ€è¦æ•°æ®è¿ç§»**: ä¸ºæ‰€æœ‰è®°å½•è®¾ç½® `deleted_at = NULL`

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. åœ¨Repository/CRUDåŸºç±»ä¸­å®ç°è½¯åˆ é™¤
```python
class BaseRepository:
    def soft_delete(self, id: int):
        """è½¯åˆ é™¤"""
        obj = self.get(id)
        obj.deleted_at = datetime.now()
        self.session.commit()
    
    def restore(self, id: int):
        """æ¢å¤è½¯åˆ é™¤"""
        obj = self.session.get(self.model, id)
        obj.deleted_at = None
        self.session.commit()
    
    def permanent_delete(self, id: int):
        """æ°¸ä¹…åˆ é™¤(æ…ç”¨)"""
        obj = self.session.get(self.model, id)
        self.session.delete(obj)
        self.session.commit()
```

### 2. æ·»åŠ å›æ”¶ç«™API
```python
@router.get("/users/recycled")
async def get_recycled_users():
    """è·å–å›æ”¶ç«™ä¸­çš„ç”¨æˆ·"""
    return await crud.get_deleted_users()

@router.post("/users/{id}/restore")
async def restore_user(id: int):
    """ä»å›æ”¶ç«™æ¢å¤ç”¨æˆ·"""
    return await crud.restore_user(id)
```

### 3. å®šæœŸæ¸…ç†è¿‡æœŸçš„è½¯åˆ é™¤æ•°æ®
```python
# æ¸…ç†30å¤©å‰çš„è½¯åˆ é™¤æ•°æ®(å®šæ—¶ä»»åŠ¡)
async def cleanup_old_deleted_data():
    """æ¸…ç†30å¤©å‰çš„è½¯åˆ é™¤æ•°æ®"""
    threshold = datetime.now() - timedelta(days=30)
    await session.execute(
        delete(UserModel).where(
            UserModel.deleted_at < threshold
        )
    )
```

---

## æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å…±å®Œæˆ3é¡¹æ”¹è¿›:

1. âœ… **è¡¥å……TenantModelåå‘å…³è”** - å®Œå–„ORMå…³ç³»
2. âœ… **æ·»åŠ è”åˆå”¯ä¸€ç´¢å¼•** - ç¬¦åˆå¤šç§Ÿæˆ·éš”ç¦»åŸåˆ™
3. âœ… **æ·»åŠ è½¯åˆ é™¤æ”¯æŒ** - æå‡æ•°æ®å®‰å…¨æ€§

**ç³»ç»Ÿè¯„åˆ†**: 98.5/100 â­â­â­â­â­

å‰©ä½™1.5åˆ†æ‰£åˆ†é¡¹:
- éœ€è¦å®ç°Repositoryå±‚çš„è½¯åˆ é™¤å°è£…
- éœ€è¦æ·»åŠ å›æ”¶ç«™UIåŠŸèƒ½
- éœ€è¦å®šæœŸæ¸…ç†ç­–ç•¥

**é€‚ç”¨æ€§**: å®Œå…¨ç¬¦åˆä¼ä¸šçº§SaaSå¤šç§Ÿæˆ·ç³»ç»Ÿæ ‡å‡†,å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒ! ğŸ‰
